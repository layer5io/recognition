name: Build and Preview Site
on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened, closed]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
    
permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v6

      - name: Install and Build üîß
        env:
          PATH_PREFIX: /recognition/pr-preview/pr-${{ github.event.pull_request.number }}
        run: |
          npm install
          node -v
          npm run build -- --prefix-paths

      - name: Broken Link Check üîó
        uses: technote-space/broken-link-checker-action@v2
        with:
          target: ./public/**/*.html  

      - name: Zip Site
        run: |
          bash .github/workflows/script.sh

      - name: Upload files
        uses: actions/upload-artifact@master
        with:
          name: public-dir
          path: public-dir.zip
          retention-days: 1

  preview:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v6
      
      - name: Download pre-built site
        uses: actions/download-artifact@v4
        with:
          name: public-dir
          path: .

      - name: Extract site
        run: |
          unzip -q public-dir.zip
          if [ -d "public-dir" ] && [ ! -d "public" ]; then
            mv public-dir public
          elif [ ! -d "public" ]; then
            echo "Warning: Neither public nor public-dir found after extraction"
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          destination_dir: pr-preview/pr-${{ github.event.pull_request.number }}
          publish_branch: gh-pages
          keep_files: true
          commit_message: 'Deploy preview for PR #${{ github.event.pull_request.number }}'
          user_name: 'l5io'
          user_email: 'ci@layer5.io'
          full_commit_message: 'Deploy preview for PR #${{ github.event.pull_request.number }}\n\nSigned-off-by: l5io <l5io@users.noreply.github.com>'

      - name: Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://layer5io.github.io/recognition/pr-preview/pr-${prNumber}/`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ Preview deployed to: ${previewUrl}`
            });

  cleanup:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v6
        with:
          ref: gh-pages

      - name: Remove PR preview
        run: |
          rm -rf pr-preview/pr-${{ github.event.pull_request.number }}
          git config user.name 'l5io'
          git config user.email 'ci@layer5.io'
          git add .
          git commit --signoff -m "Remove preview for PR #${{ github.event.pull_request.number }}" || echo "Nothing to commit"
          git push

      - name: Comment cleanup on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üßπ Preview deployment has been cleaned up.'
            });